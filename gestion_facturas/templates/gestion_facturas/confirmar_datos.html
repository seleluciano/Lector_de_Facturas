{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Confirmar Datos de Facturas</h2>
    <form method="post" action="{% url 'gestion_facturas:guardar_factura' %}">
        {% csrf_token %}
        {% for factura in facturas %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-invoice"></i> 
                    Factura {{ forloop.counter }} - {{ factura.nombre_archivo }}
                </h5>
            </div>
            <div class="card-body">
                <!-- Imagen de la factura -->
                <div class="row mb-4 justify-content-center">
                    <div class="col-md-6 text-center">
                        <h6>Imagen Original</h6>
                        <img src="data:image/png;base64,{{ factura.imagen_original_base64 }}" 
                             class="img-fluid" 
                             style="max-width: 80%;"
                             alt="Factura {{ forloop.counter }}">
                    </div>
                </div>
                <!-- Campos de datos -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="tipo_factura_{{ forloop.counter }}" class="form-label">Tipo de Factura</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="tipo_factura_{{ forloop.counter }}" 
                                   name="tipo_factura_{{ forloop.counter }}" 
                                   value="{{ factura.datos.tipo_factura|default:'' }}" 
                                   required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="punto_venta_{{ forloop.counter }}" class="form-label">Punto de Venta</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="punto_venta_{{ forloop.counter }}" 
                                   name="punto_venta_{{ forloop.counter }}" 
                                   value="{{ factura.datos.punto_venta|default:'' }}" 
                                   required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="numero_{{ forloop.counter }}" class="form-label">Número</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="numero_{{ forloop.counter }}" 
                                   name="numero_{{ forloop.counter }}" 
                                   value="{{ factura.datos.numero|default:'' }}" 
                                   required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="fecha_{{ forloop.counter }}" class="form-label">Fecha de Emisión</label>
                            <input type="text"
                                   class="form-control"
                                   id="fecha_{{ forloop.counter }}"
                                   name="fecha_{{ forloop.counter }}"
                                   value="{{ factura.datos.fecha|default:'' }}"
                                   required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="tipo_copia_{{ forloop.counter }}" class="form-label">Tipo de Copia</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="tipo_copia_{{ forloop.counter }}" 
                                   name="tipo_copia_{{ forloop.counter }}" 
                                   value="{{ factura.datos.tipo_copia|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="cuit_{{ forloop.counter }}" class="form-label">CUIT/CUIL/DNI Cliente</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="cuit_{{ forloop.counter }}" 
                                   name="cuit_{{ forloop.counter }}" 
                                   value="{{ factura.datos.cuit|default:'' }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="cuit_emisor_{{ forloop.counter }}" class="form-label">CUIT/CUIL Emisor</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="cuit_emisor_{{ forloop.counter }}" 
                                   name="cuit_emisor_{{ forloop.counter }}" 
                                   value="{{ factura.datos.cuit_emisor|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="razon_social_cliente_{{ forloop.counter }}" class="form-label">Razón Social Cliente</label>
                            <input type="text"
                                   class="form-control"
                                   id="razon_social_cliente_{{ forloop.counter }}"
                                   name="razon_social_cliente_{{ forloop.counter }}"
                                   value="{{ factura.datos.razon_social_cliente|default:'' }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="razon_social_emisor_{{ forloop.counter }}" class="form-label">Razón Social Emisor</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="razon_social_emisor_{{ forloop.counter }}" 
                                   name="razon_social_emisor_{{ forloop.counter }}" 
                                   value="{{ factura.datos.razon_social_emisor|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="condicion_venta_{{ forloop.counter }}" class="form-label">Condición de Venta</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="condicion_venta_{{ forloop.counter }}" 
                                   name="condicion_venta_{{ forloop.counter }}" 
                                   value="{{ factura.datos.condicion_venta|default:'' }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="condicion_iva_{{ forloop.counter }}" class="form-label">Condición IVA</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="condicion_iva_{{ forloop.counter }}" 
                                   name="condicion_iva_{{ forloop.counter }}" 
                                   value="{{ factura.datos.condicion_iva|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Productos -->
                <div class="mb-3">
                    <h6>Productos:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Bonificación</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="productos_{{ forloop.counter }}">
                                {% for producto in factura.datos.productos %}
                                <tr>
                                    <td>
                                        <input type="text" 
                                               class="form-control form-control-sm" 
                                               name="producto_descripcion_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" 
                                               value="{{ producto.descripcion|default:'' }}" 
                                               required>
                                    </td>
                                    <td>
                                        <input type="text" 
                                               class="form-control form-control-sm cantidad" 
                                               name="producto_cantidad_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" 
                                               value="{{ producto.cantidad|default:'0.00' }}" 
                                               step="0.01" 
                                               required>
                                    </td>
                                    <td>
                                        <input type="text" 
                                               class="form-control form-control-sm" 
                                               name="producto_precio_unitario_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" 
                                               value="{{ producto.precio_unitario|default:'0.00'|floatformat:2 }}" 
                                               step="0.01">
                                    </td>
                                    <td>
                                        <input type="text" 
                                               class="form-control form-control-sm" 
                                               name="producto_importe_bonificado_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" 
                                               value="{{ producto.importe_bonificado|default:'0.00'|floatformat:2 }}" 
                                               step="0.01">
                                    </td>
                                    <td>
                                        <input type="text" 
                                               class="form-control form-control-sm" 
                                               name="producto_subtotal_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" 
                                               value="{{ producto.subtotal|default:'0.00'|floatformat:2 }}" 
                                               step="0.01">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Totales -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="subtotal_{{ forloop.counter }}" class="form-label">Subtotal</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="subtotal_{{ forloop.counter }}" 
                                   name="subtotal_{{ forloop.counter }}" 
                                   value="{{ factura.datos.subtotal|default:'0.00'|floatformat:2 }}" 
                                   required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="iva_{{ forloop.counter }}" class="form-label">IVA</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="iva_{{ forloop.counter }}" 
                                   name="iva_{{ forloop.counter }}" 
                                   value="{{ factura.datos.iva|default:'0.00'|floatformat:2 }}" 
                                   required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="percepcion_iibb_{{ forloop.counter }}" class="form-label">Percepción IIBB</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="percepcion_iibb_{{ forloop.counter }}" 
                                   name="percepcion_iibb_{{ forloop.counter }}" 
                                   value="{{ factura.datos.percepcion_iibb|default:'0.00'|floatformat:2 }}" 
                                   required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="otros_tributos_{{ forloop.counter }}" class="form-label">Otros Tributos</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="otros_tributos_{{ forloop.counter }}" 
                                   name="otros_tributos_{{ forloop.counter }}" 
                                   value="{{ factura.datos.otros_tributos|default:'0.00'|floatformat:2 }}" 
                                   required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="total_{{ forloop.counter }}" class="form-label">Total</label>
                            <input type="text" 
                                   step="0.01" 
                                   class="form-control" 
                                   id="total_{{ forloop.counter }}" 
                                   name="total_{{ forloop.counter }}" 
                                   value="{{ factura.datos.monto_total|default:'0.00'|floatformat:2 }}" 
                                   required>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="d-flex justify-content-between mb-4">
            <a href="{% url 'gestion_facturas:cargar_factura' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Facturas
            </button>
        </div>
    </form>
</div>

<!-- Script para manejar productos -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Agregar producto
    document.querySelectorAll('.agregar-producto').forEach(button => {
        button.addEventListener('click', function() {
            const facturaIndex = this.getAttribute('data-factura');
            const tbody = document.getElementById(`productos_${facturaIndex}`);
            const newIndex = tbody.children.length + 1;
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           name="producto_descripcion_${facturaIndex}_${newIndex}" 
                           required>
                </td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm cantidad" 
                           name="producto_cantidad_${facturaIndex}_${newIndex}" 
                           step="0.01" 
                           required>
                </td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           name="producto_precio_unitario_${facturaIndex}_${newIndex}" 
                           step="0.01">
                </td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           name="producto_importe_bonificado_${facturaIndex}_${newIndex}" 
                           step="0.01">
                </td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           name="producto_subtotal_${facturaIndex}_${newIndex}" 
                           step="0.01">
                </td>
            `;
            tbody.appendChild(newRow);
        });
    });
});
</script>
{% endblock %}